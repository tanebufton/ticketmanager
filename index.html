<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discord Ticket Manager</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        .emoji-picker {
            height: 200px;
            overflow-y: auto;
        }
        .field-card {
            border-left: 4px solid #6366f1;
        }
        .hidden-field {
            display: none;
        }
        #ticketsList > div {
            cursor: grab;
        }
        #ticketsList > div:active {
            cursor: grabbing;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <header class="bg-indigo-600 text-white shadow-lg">
        <div class="container mx-auto px-4 py-6">
            <div class="flex justify-between items-center">
                <h1 class="text-3xl font-bold">Discord Ticket Manager</h1>
                <div>
                    <button id="importBtn" class="bg-indigo-700 hover:bg-indigo-800 px-4 py-2 rounded-lg mr-2">
                        <i class="fas fa-file-import mr-2"></i>Import
                    </button>
                    <button id="exportBtn" class="bg-indigo-700 hover:bg-indigo-800 px-4 py-2 rounded-lg">
                        <i class="fas fa-file-export mr-2"></i>Export
                    </button>
                </div>
            </div>
        </div>
    </header>
    <main class="container mx-auto px-4 py-8">
        <div class="flex mb-8 gap-4 flex-wrap">
            <div class="bg-white rounded-lg shadow-md p-6 w-full lg:w-1/3">
                <h2 class="text-2xl font-bold mb-4 text-gray-800">Add New Ticket Type</h2>
                <form id="ticketForm">
                    <div class="mb-4 hidden-field">
                        <label class="block text-gray-700 mb-2">Type ID</label>
                        <input type="text" id="typeId" class="w-full p-2 border border-gray-300 rounded-md"
                            placeholder="general_enquiry" readonly>
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 mb-2">Name</label>
                        <input type="text" id="name" class="w-full p-2 border border-gray-300 rounded-md"
                            placeholder="General Enquiry" required maxlength="80">
                        <p class="text-sm text-gray-500 mt-1">Maximum 80 characters</p>
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 mb-2">Emoji</label>
                        <div class="flex gap-2">
                            <input type="text" id="emoji" class="w-full p-2 border border-gray-300 rounded-md"
                                placeholder="Select Emoji" maxlength="2" required>
                            <button type="button" id="emojiPickerBtn" class="bg-gray-200 hover:bg-gray-300 p-2 rounded-md">
                                😀
                            </button>
                        </div>
                        <div id="emojiPicker" class="emoji-picker hidden mt-2 bg-white border border-gray-300 rounded-md p-2 grid grid-cols-8 gap-1"></div>
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 mb-2">Channel Prefix</label>
                        <input type="text" id="prefix" class="w-full p-2 border border-gray-300 rounded-md"
                            placeholder="ticket" required>
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 mb-2">Role IDs (comma separated)</label>
                        <textarea id="roles" class="w-full p-2 border border-gray-300 rounded-md"
                            placeholder="1092027172195152033, 987654321012345678" rows="2"></textarea>
                        <p class="text-sm text-gray-500 mt-1">Enter Discord role IDs separated by commas - Your Admin role will always be added by default</p>
                        <p class="text-xs text-gray-500 mt-1">
                            Don't know how to get Role ID? Go to <a href="https://discordhelp.net/role-id" target="_blank" rel="noopener noreferrer" class="text-blue-500 hover:underline">discordhelp.net/role-id</a>
                        </p>
                    </div>
                    <h3 class="text-xl font-bold mb-2 text-gray-800">Fields</h3>
                    <div id="fieldsContainer">
                        </div>
                    <button type="button" id="addFieldBtn" class="bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded-md my-4">
                        <i class="fas fa-plus mr-2"></i>Add Field
                    </button>
                    <p id="maxFieldsWarning" class="text-sm text-red-500 mt-2 hidden">Maximum 25 fields allowed.</p>
                    <div class="flex justify-end mt-4">
                        <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-md">
                            <i class="fas fa-save mr-2"></i>Save Ticket Type
                        </button>
                    </div>
                </form>
            </div>
            <div class="bg-white rounded-lg shadow-md p-6 w-full lg:w-3/5">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-gray-800">Ticket Types</h2>
                    <div>
                        <button id="clearAllBtn" class="text-red-600 hover:text-red-800">
                            <i class="fas fa-trash mr-1"></i>Clear All
                        </button>
                    </div>
                </div>
                <div id="ticketsList" class="space-y-4">
                    <div class="text-gray-500 text-center py-8">No ticket types added yet</div>
                </div>
            </div>
        </div>
    </main>
    <div id="emojiModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg p-6 w-96 max-w-full">
            <h3 class="text-xl font-bold mb-4">Select an Emoji</h3>
            <div class="emoji-grid grid grid-cols-8 gap-2 h-64 overflow-y-auto">
                </div>
            <div class="mt-4 flex justify-end">
                <button id="closeEmojiModal" class="bg-gray-300 hover:bg-gray-400 px-4 py-2 rounded-md">
                    Cancel
                </button>
            </div>
        </div>
    </div>
    <div id="importModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg p-6 w-96 max-w-full">
            <h3 class="text-xl font-bold mb-4">Import Configuration</h3>
            <div class="mb-4">
                <label class="block text-gray-700 mb-2">Upload JSON File</label>
                <input type="file" id="importFile" accept=".json" class="w-full p-2 border border-gray-300 rounded-md">
            </div>
            <div class="mt-4 flex justify-end space-x-2">
                <button id="closeImportModal" class="bg-gray-300 hover:bg-gray-400 px-4 py-2 rounded-md">
                    Cancel
                </button>
                <button id="confirmImport" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md">
                    Import
                </button>
            </div>
        </div>
    </div>
    <div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg p-6 w-96 max-w-full">
            <h3 class="text-xl font-bold mb-4">Confirm Action</h3>
            <p id="confirmMessage" class="mb-4"></p>
            <div class="mt-4 flex justify-end space-x-2">
                <button id="cancelAction" class="bg-gray-300 hover:bg-gray-400 px-4 py-2 rounded-md">
                    Cancel
                </button>
                <button id="confirmAction" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-md">
                    Confirm
                </button>
            </div>
        </div>
    </div>
    <div id="exportModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg p-6 w-96 max-w-full">
            <h3 class="text-xl font-bold mb-4">Export Configuration</h3>
            <p class="mb-4 text-gray-700">
                Your configuration has been exported to <code class="text-sm font-mono">ticket_config.json</code>.
                To import this into your Discord server, use the <code class="text-sm font-mono">/ticket_import</code> command and upload the file.
            </p>
            <div class="mt-4 flex justify-end">
                <button id="closeExportModal" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md">
                    Close
                </button>
            </div>
        </div>
    </div>
    <script>
        // Common emojis for Discord ticket types
        const commonEmojis = [
            '🎟️', '📩', '🔧', '❓', '💡', '🐛', '📊', '🚀', '📝', '👤', '🎮', '🔨',
            '🛠️', '📢', '📣', '🆘', '💬', '👋', '🎭', '🔔', '💰', '🎁', '🏆', '⚙️',
            '📱', '💻', '🖥️', '📈', '📉', '📊', '📋', '📌', '📎', '🔍', '🔎', '🔐',
            '🔑', '🔒', '🔓', '🚫', '⛔', '⚠️', '❌', '✅', '⭐', '🌟', '💫', '🔆'
        ];
        // Global variables
        let ticketTypes = [];
        let fieldCounter = 0;
        let editingIndex = -1;
        let confirmCallback = null;
        let draggedItem = null;
        const MAX_FIELDS = 25;
        // DOM Elements
        const form = document.getElementById('ticketForm');
        const typeIdInput = document.getElementById('typeId');
        const fieldsContainer = document.getElementById('fieldsContainer');
        const ticketsList = document.getElementById('ticketsList');
        const addFieldBtn = document.getElementById('addFieldBtn');
        const maxFieldsWarning = document.getElementById('maxFieldsWarning');
        const emojiPicker = document.getElementById('emojiPicker');
        const emojiPickerBtn = document.getElementById('emojiPickerBtn');
        const emojiModal = document.getElementById('emojiModal');
        const emojiGrid = document.querySelector('.emoji-grid');
        const closeEmojiModal = document.getElementById('closeEmojiModal');
        const importBtn = document.getElementById('importBtn');
        const exportBtn = document.getElementById('exportBtn');
        const importModal = document.getElementById('importModal');
        const closeImportModal = document.getElementById('closeImportModal');
        const confirmImport = document.getElementById('confirmImport');
        const importFile = document.getElementById('importFile');
        const confirmModal = document.getElementById('confirmModal');
        const confirmMessage = document.getElementById('confirmMessage');
        const confirmAction = document.getElementById('confirmAction');
        const cancelAction = document.getElementById('cancelAction');
        const clearAllBtn = document.getElementById('clearAllBtn');
        const exportModal = document.getElementById('exportModal');
        const closeExportModal = document.getElementById('closeExportModal');
        const rolesInput = document.getElementById('roles');


        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Load ticket types from local storage
            loadTicketTypes();
            renderTicketTypes();

            // Set up emoji picker
            setupEmojiPicker();

            // Add event listeners
            form.addEventListener('submit', handleFormSubmit);
            addFieldBtn.addEventListener('click', addField);
            emojiPickerBtn.addEventListener('click', toggleEmojiPicker);
            closeEmojiModal.addEventListener('click', () => emojiModal.classList.add('hidden'));
            importBtn.addEventListener('click', () => importModal.classList.remove('hidden'));
            closeImportModal.addEventListener('click', () => importModal.classList.add('hidden'));
            confirmImport.addEventListener('click', handleImport);
            exportBtn.addEventListener('click', handleExport);
            cancelAction.addEventListener('click', () => confirmModal.classList.add('hidden'));
            clearAllBtn.addEventListener('click', () => showConfirm('Are you sure you want to clear all ticket types?', clearAllTicketTypes));
            closeExportModal.addEventListener('click', () => exportModal.classList.add('hidden'));

            // Initialize with one field
            addField();

            // Set up drag and drop for ticket types
            setupDragAndDrop();
        });

        // Function to generate a unique ID
        function generateId(prefix = "") {
            return prefix + Math.random().toString(36).substring(2, 15);
        }

        // Function to set up emoji picker
        function setupEmojiPicker() {
          emojiGrid.innerHTML = '';
          fetch('https://cdn.jsdelivr.net/gh/github/gemoji/db/emoji.json')
            .then(response => response.json())
            .then(emojis => {
              emojis.forEach(emoji => {
                if (emoji.emoji) { // Some entries have no emoji
                  const emojiBtn = document.createElement('button');
                  emojiBtn.className = 'p-2 text-xl hover:bg-gray-100 rounded';
                  emojiBtn.textContent = emoji.emoji;
                  emojiBtn.onclick = () => {
                    document.getElementById('emoji').value = emoji.emoji;
                    emojiModal.classList.add('hidden');
                  };
                  emojiGrid.appendChild(emojiBtn);
                }
              });
            });
        }

        // Toggle emoji picker visibility
        function toggleEmojiPicker() {
            emojiModal.classList.remove('hidden');
        }

        // Add a new field to the form
        function addField() {
            if (fieldsContainer.children.length >= MAX_FIELDS) {
                maxFieldsWarning.classList.remove('hidden');
                return;
            }
            maxFieldsWarning.classList.add('hidden');

            const fieldId = generateId('field-');
            const fieldDiv = document.createElement('div');
            fieldDiv.className = 'field-card bg-gray-50 p-4 rounded-md mb-4 border border-gray-200';
            fieldDiv.id = fieldId;

            fieldDiv.innerHTML = `
                <div class="flex justify-between items-center mb-2">
                    <h4 class="font-bold text-gray-700">Field ${fieldsContainer.children.length + 1}</h4>
                    <button type="button" class="text-red-500 hover:text-red-700" onclick="removeField('${fieldId}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
                <div class="mb-2">
                    <label class="block text-gray-700 mb-1 text-sm">Label (Question)</label>
                    <input type="text" class="field-label w-full p-2 border border-gray-300 rounded-md"
                        placeholder="How can we help you?" required maxlength="80">
                         <p class="text-sm text-gray-500 mt-1">Maximum 80 characters</p>
                </div>
                <div class="mb-2 hidden-field">
                    <label class="block text-gray-700 mb-1 text-sm">Custom ID</label>
                    <input type="text" class="field-id w-full p-2 border border-gray-300 rounded-md"
                        value="${generateId('custom-')}" readonly required>
                </div>
                <div class="mb-2">
                    <label class="block text-gray-700 mb-1 text-sm">Style</label>
                    <select class="field-style w-full p-2 border border-gray-300 rounded-md">
                        <option value="short">Short (single line)</option>
                        <option value="paragraph">Paragraph (multiple lines)</option>
                        <option value="text">Text Input</option>
                        <option value="select">Select Menu</option>
                        <option value="string">String Input</option>
                    </select>
                </div>
                 <div id="options-container-${fieldId}" class="mt-2 hidden">
                    <label class="block text-gray-700 mb-1 text-sm">Options</label>
                    <div class="flex flex-col gap-2">
                        <div class="flex gap-2">
                            <input type="text" class="field-option-label w-full p-2 border border-gray-300 rounded-md" placeholder="Option Label" maxlength="100">
                            <input type="text" class="field-option-value w-full p-2 border border-gray-300 rounded-md" placeholder="Option Value"  maxlength="100">
                            <button type="button" class="bg-gray-200 hover:bg-gray-300 p-2 rounded-md" onclick="addOption(this)">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                    <p class="text-sm text-gray-500 mt-1">Enter label and value for each option.</p>
                </div>
                <div class="mb-2 hidden" id="maxlength-container-${fieldId}">
                    <label class="block text-gray-700 mb-1 text-sm">Maximum Length</label>
                    <input type="number" class="field-maxlength w-full p-2 border border-gray-300 rounded-md" value="200" min="1" >
                    <p class="text-sm text-gray-500 mt-1">Maximum characters allowed</p>
                </div>
            `;
            fieldsContainer.appendChild(fieldDiv);
            const styleSelect = fieldDiv.querySelector('.field-style');
            const optionsContainer = fieldDiv.querySelector(`#options-container-${fieldId}`);
             const maxlengthContainer = fieldDiv.querySelector(`#maxlength-container-${fieldId}`);

            styleSelect.addEventListener('change', () => {
                if (styleSelect.value === 'select') {
                    optionsContainer.classList.remove('hidden');
                     maxlengthContainer.classList.add('hidden');
                } else if (styleSelect.value === 'text') {
                    optionsContainer.classList.add('hidden');
                    maxlengthContainer.classList.remove('hidden');
                }
                else {
                    optionsContainer.classList.add('hidden');
                     maxlengthContainer.classList.add('hidden');
                }
            });
        }

        // Remove a field from the form
        window.removeField = function(fieldId) {
            const field = document.getElementById(fieldId);
            if (field && fieldsContainer.children.length > 1) {
                field.remove();
                // Update field numbers
                Array.from(fieldsContainer.children).forEach((field, index) => {
                    field.querySelector('h4').textContent = `Field ${index + 1}`;
                });
            } else if (fieldsContainer.children.length <= 1) {
                alert('You must have at least one field.');
            }
             if (fieldsContainer.children.length < MAX_FIELDS) {
                maxFieldsWarning.classList.add('hidden');
            }
        };

        window.addOption = function(buttonElement) {
            const optionsContainer = buttonElement.parentNode.parentNode;
            const newOptionDiv = document.createElement('div');
            newOptionDiv.className = 'flex gap-2';
            newOptionDiv.innerHTML = `
                <input type="text" class="field-option-label w-full p-2 border border-gray-300 rounded-md" placeholder="Option Label"  maxlength="100">
                <input type="text" class="field-option-value w-full p-2 border border-gray-300 rounded-md" placeholder="Option Value"  maxlength="100">
                <button type="button" class="bg-red-200 hover:bg-red-300 p-2 rounded-md" onclick="removeOption(this)">
                    <i class="fas fa-trash"></i>
                </button>
            `;
            optionsContainer.appendChild(newOptionDiv);
        };

        window.removeOption = function(buttonElement) {
            buttonElement.parentNode.remove();
        };

        // Handle form submission
        function handleFormSubmit(e) {
            e.preventDefault();

            // Get form values
            const name = document.getElementById('name').value.trim();
             if (name.length > 80) {
                  alert('Name must be 80 characters or less.');
                  return;
             }
            const emoji = document.getElementById('emoji').value.trim();
            const prefix = document.getElementById('prefix').value.trim();
            const rolesInput = document.getElementById('roles').value.trim();

            // Parse roles, ensuring they are strings
            const roles = rolesInput
                ? rolesInput.split(',').map(role => role.trim()).filter(role => role)
                : [];

            // Get fields
            const fields = Array.from(fieldsContainer.children).map(field => {
                const label = field.querySelector('.field-label').value.trim();
                 if (label.length > 80){
                    alert('Field Label must be 80 characters or less.');
                    throw new Error('Field Label too long');
                 }
                const fieldStyle = field.querySelector('.field-style').value;
                const fieldData = {
                    label: label,
                    custom_id: field.querySelector('.field-id').value,
                    style: fieldStyle,
                }

                if (fieldStyle === 'select'){
                    const optionLabels = Array.from(field.querySelectorAll('.field-option-label')).map(input => input.value.trim());
                    const optionValues = Array.from(field.querySelectorAll('.field-option-value')).map(input => input.value.trim());
                    if (optionLabels.some(label => !label) || optionValues.some(value => !value)) {
                         alert('Please provide both label and value for all options.');
                         throw new Error('Missing option label or value');
                    }
                    const options = optionLabels.map((label, index) => ({
                        label: label,
                        value: optionValues[index]
                    }));
                    fieldData.options = options;
                }
                 if (fieldStyle === 'text'){
                    fieldData.maxlength = parseInt(field.querySelector('.field-maxlength').value);
                }
                return fieldData;
            });

            // Create ticket type object
            const ticketType = {
                type_id: editingIndex >= 0 ? ticketTypes[editingIndex].type_id : generateId('ticket-'),
                name,
                emoji,
                roles: roles,
                prefix,
                fields
            };

            // Add or update ticket type
            if (editingIndex >= 0) {
                ticketTypes[editingIndex] = ticketType;
                editingIndex = -1;
            } else {
                // Check for duplicate type_id
                if (ticketTypes.some(t => t.type_id === ticketType.type_id)) {
                    alert(`A ticket type with ID "${ticketType.type_id}" already exists.`);
                    return;
                }
                ticketTypes.push(ticketType);
            }

            // Save and reset
            saveTicketTypes();
            renderTicketTypes();
            resetForm();
        }

        // Reset the form
        function resetForm() {
            document.getElementById('name').value = '';
            document.getElementById('emoji').value = 'Select Emoji';
            document.getElementById('prefix').value = '';
            document.getElementById('roles').value = '';

            // Clear fields except for one
            fieldsContainer.innerHTML = '';
            addField();
            // Enable type_id field
            typeIdInput.disabled = false;
             maxFieldsWarning.classList.add('hidden');
        }

        // Save ticket types to local storage
        function saveTicketTypes() {
            localStorage.setItem('discordTicketTypes', JSON.stringify(ticketTypes));
        }

        // Load ticket types from local storage
        function loadTicketTypes() {
            const stored = localStorage.getItem('discordTicketTypes');
            if (stored) {
                ticketTypes = JSON.parse(stored);
            }
        }

        // Render ticket types list
        function renderTicketTypes() {
            if (ticketTypes.length === 0) {
                ticketsList.innerHTML = '<div class="text-gray-500 text-center py-8">No ticket types added yet</div>';
                return;
            }
            ticketsList.innerHTML = '';
            ticketTypes.forEach((ticket, index) => {
                const ticketDiv = document.createElement('div');
                ticketDiv.className = 'bg-gray-50 rounded-md p-4 border border-gray-200';
                ticketDiv.draggable = true;
                ticketDiv.dataset.index = index;
                ticketDiv.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="text-xl font-bold">${ticket.emoji} ${ticket.name}</h3>
                            <p class="text-gray-600">ID: ${ticket.type_id}</p>
                            <p class="text-gray-600">Prefix: ${ticket.prefix}</p>
                            <p class="text-gray-600">Roles: ${ticket.roles.length > 0 ? ticket.roles.join(', ') : 'No roles'}</p>
                        </div>
                        <div class="flex space-x-2">
                            <button class="edit-btn text-blue-600 hover:text-blue-800" data-index="${index}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="delete-btn text-red-600 hover:text-red-800" data-index="${index}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="mt-3">
                        <h4 class="font-bold text-gray-700">Fields (${ticket.fields.length})</h4>
                        <ul class="list-disc pl-5 mt-1">
                            ${ticket.fields.map(field => {
                                let fieldInfo = `${field.label} <span class="text-xs text-gray-500">(${field.style})`;
                                if (field.style === 'select' && field.options) {
                                    fieldInfo += `<br><span class="text-xs text-gray-500">Options: ${field.options.map(opt => opt.label).join(', ')}</span>`;
                                }
                                 if (field.style === 'text' && field.maxlength) {
                                    fieldInfo += `<br><span class="text-xs text-gray-500">Max Length: ${field.maxlength}</span>`;
                                }
                                return `<li class="text-gray-600">${fieldInfo}</li>`;
                            }).join('')}
                        </ul>
                    </div>
                `;
                ticketsList.appendChild(ticketDiv);
            });
            // Add edit/delete event listeners
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', () => editTicketType(parseInt(btn.dataset.index)));
            });
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const index = parseInt(btn.dataset.index);
                    showConfirm(`Are you sure you want to delete "${ticketTypes[index].name}"?`, () => deleteTicketType(index));
                });
            });
            //Re-attach drag and drop
            setupDragAndDrop();
        }

        // Edit a ticket type
        function editTicketType(index) {
            const ticket = ticketTypes[index];
            editingIndex = index;

            // Fill the form
            typeIdInput.value = ticket.type_id;
            typeIdInput.disabled = true; // Don't allow changing the ID
            document.getElementById('name').value = ticket.name;
            document.getElementById('emoji').value = ticket.emoji;
            document.getElementById('prefix').value = ticket.prefix;
            document.getElementById('roles').value = ticket.roles.join(', ');

            // Clear fields
            fieldsContainer.innerHTML = '';
            // Add fields
            ticket.fields.forEach(field => {
                const fieldId = generateId('field-');
                const fieldDiv = document.createElement('div');
                fieldDiv.className = 'field-card bg-gray-50 p-4 rounded-md mb-4 border border-gray-200';
                fieldDiv.id = fieldId;
                let optionsHtml = '';
                let maxlengthHtml = '';
                if (field.style === 'select' && field.options) {
                    optionsHtml = `<div class="mt-2" id="options-container-${fieldId}">
                        <label class="block text-gray-700 mb-1 text-sm">Options (for Select Menu)</label>
                        <div class="flex flex-col gap-2">
                            ${field.options.map(option => `
                                <div class="flex gap-2">
                                    <input type="text" class="field-option-label w-full p-2 border border-gray-300 rounded-md" value="${option.label}" placeholder="Option Label"  maxlength="100">
                                    <input type="text" class="field-option-value w-full p-2 border border-gray-300 rounded-md" value="${option.value}" placeholder="Option Value"  maxlength="100">
                                    <button type="button" class="bg-red-200 hover:bg-red-300 p-2 rounded-md" onclick="removeOption(this)">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            `).join('')}
                        </div>
                        <p class="text-sm text-gray-500 mt-1">Enter label and value for each option.</p>
                    </div>`;
                }
                if (field.style === 'text' && field.maxlength) {
                     maxlengthHtml = `<div class="mb-2" id="maxlength-container-${fieldId}">
                        <label class="block text-gray-700 mb-1 text-sm">Maximum Length</label>
                        <input type="number" class="field-maxlength w-full p-2 border border-gray-300 rounded-md" value="${field.maxlength}" min="1" >
                        <p class="text-sm text-gray-500 mt-1">Maximum characters allowed</p>
                    </div>`;
                }

                fieldDiv.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <h4 class="font-bold text-gray-700">Field ${fieldsContainer.children.length + 1}</h4>
                        <button type="button" class="text-red-500 hover:text-red-700" onclick="removeField('${fieldId}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <div class="mb-2">
                        <label class="block text-gray-700 mb-1 text-sm">Label (Question)</label>
                        <input type="text" class="field-label w-full p-2 border border-gray-300 rounded-md"
                            value="${field.label}" required maxlength="80">
                            <p class="text-sm text-gray-500 mt-1">Maximum 80 characters</p>
                    </div>
                    <div class="mb-2 hidden-field">
                        <label class="block text-gray-700 mb-1 text-sm">Custom ID</label>
                        <input type="text" class="field-id w-full p-2 border border-gray-300 rounded-md"
                            value="${field.custom_id}" readonly required>
                    </div>
                    <div class="mb-2">
                        <label class="block text-gray-700 mb-1 text-sm">Style</label>
                        <select class="field-style w-full p-2 border border-gray-300 rounded-md">
                            <option value="short" ${field.style === 'short' ? 'selected' : ''}>Short (single line)</option>
                            <option value="paragraph" ${field.style === 'paragraph' ? 'selected' : ''}>Paragraph (multiple lines)</option>
                             <option value="text" ${field.style === 'text' ? 'selected' : ''}>Text Input</option>
                            <option value="select" ${field.style === 'select' ? 'selected' : ''}>Select Menu</option>
                            <option value="string" ${field.style === 'string' ? 'selected' : ''}>String Input</option>
                        </select>
                    </div>
                    ${optionsHtml}
                    ${maxlengthHtml}
                `;
                fieldsContainer.appendChild(fieldDiv);
                 const styleSelect = fieldDiv.querySelector('.field-style');
                const optionsContainer = fieldDiv.querySelector(`#options-container-${fieldId}`);
                const maxlengthContainer = fieldDiv.querySelector(`#maxlength-container-${fieldId}`);

                styleSelect.addEventListener('change', () => {
                    if (styleSelect.value === 'select') {
                        optionsContainer.classList.remove('hidden');
                         maxlengthContainer.classList.add('hidden');
                    } else if (styleSelect.value === 'text'){
                        optionsContainer.classList.add('hidden');
                        maxlengthContainer.classList.remove('hidden');
                    }
                    else {
                        optionsContainer.classList.add('hidden');
                        maxlengthContainer.classList.add('hidden');
                    }
                });
            });
            // If no fields, add one
            if (ticket.fields.length === 0) {
                addField();
            }
            // Scroll to the form
            form.scrollIntoView({ behavior: 'smooth' });
        }

        // Delete a ticket type
        function deleteTicketType(index) {
            ticketTypes.splice(index, 1);
            saveTicketTypes();
            renderTicketTypes();

            // If we were editing this ticket, reset the form
            if (editingIndex === index) {
                resetForm();
            }
        }

        // Show confirmation modal
        function showConfirm(message, callback) {
            confirmMessage.textContent = message;
            confirmCallback = callback;
            confirmModal.classList.remove('hidden');

            confirmAction.onclick = () => {
                if (confirmCallback) confirmCallback();
                confirmModal.classList.add('hidden');
            };
        }

        // Clear allticket types
        function clearAllTicketTypes() {
            ticketTypes = [];
            saveTicketTypes();
            renderTicketTypes();
            resetForm();
        }

        // Export configuration
        function handleExport() {
            if (ticketTypes.length === 0) {
                alert('No ticket types to export.');
                return;
            }

            const config = {
                ticket_types: ticketTypes,
                exported_at: new Date().toISOString(),
                version: "1.0"
            };
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(config, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "ticket_config.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();

            // Show the export modal
            exportModal.classList.remove('hidden');
        }

        // Import configuration
        function handleImport() {
            const file = importFile.files[0];
            if (!file) {
                alert('Please select a file to import.');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const config = JSON.parse(e.target.result);
                    
                    // Fix roles early
                    config.ticket_types.forEach(ticket => {
                        if (!Array.isArray(ticket.roles)) {
                            if (typeof ticket.roles === 'string' && ticket.roles.trim() === '') {
                                ticket.roles = [];
                            } else {
                                ticket.roles = [];
                            }
                        }
                    });
                                       
                    // Validate the structure
                    if (!config.ticket_types || !Array.isArray(config.ticket_types)) {
                        throw new Error('Invalid configuration: missing ticket_types array');
                    }

                    // Validate each ticket type
                    config.ticket_types.forEach(ticket => {
                        const requiredFields = ['type_id', 'name', 'emoji', 'roles', 'prefix', 'fields'];
                        requiredFields.forEach(field => {
                            if (!(field in ticket)) {
                                throw new Error(`Invalid ticket type: missing ${field} field`);
                            }
                        });

                        // Validate fields
                        if (!Array.isArray(ticket.fields)) {
                            throw new Error(`Invalid fields array for ticket: ${ticket.type_id}`);
                        }
                        ticket.fields.forEach(field => {
                            if (!field.label || !field.custom_id) {
                                throw new Error(`Invalid field in ticket ${ticket.type_id}: missing label or custom_id`);
                            }
                             if (field.label.length > 80){
                                 throw new Error(`Invalid field label length:  Label must be 80 characters or less.`);
                             }
                        });
                         // Validate roles field
                        if (!Array.isArray(ticket.roles)) {
                            if (typeof ticket.roles === 'string' && ticket.roles.trim() === '') {
                                ticket.roles = [];
                            } else {
                                throw new Error(`Invalid roles format in ticket type ${ticket.type_id}. Roles must be an array of strings.`);
                            }
                        } else {
                            if (!ticket.roles.every(role => typeof role === 'string')) {
                                throw new Error(`Invalid roles format in ticket type ${ticket.type_id}. Roles must be an array of strings.`);
                            }
                        }
                    });

                    // Import valid configuration
                    ticketTypes = config.ticket_types;
                    saveTicketTypes();
                    renderTicketTypes();
                    resetForm();

                    alert(`Successfully imported ${ticketTypes.length} ticket types.`);
                    importModal.classList.add('hidden');
                    importFile.value = '';
                } catch (error) {
                    alert(`Error importing configuration: ${error.message}`);
                }
            };
            reader.readAsText(file);
        }

        function setupDragAndDrop() {
            const ticketList = document.getElementById('ticketsList');
            ticketList.addEventListener('dragstart', (event) => {
                draggedItem = event.target;
                event.dataTransfer.effectAllowed = 'move';
                // event.target.classList.add('dragging'); //optional
            });

            ticketList.addEventListener('dragover', (event) => {
                event.preventDefault();
                event.dataTransfer.dropEffect = 'move';
            });
            ticketList.addEventListener('drop', (event) => {
                event.preventDefault();
                if (event.target !== ticketList && event.target.parentNode === ticketList) {
                    const droppedItem = event.target;
                     // Find the correct index to insert the dragged item
                    let dropIndex;
                    if (droppedItem === draggedItem) {
                        return; // Prevent reordering with itself
                    }

                    const draggedIndex = parseInt(draggedItem.dataset.index);
                    const targetIndex = parseInt(droppedItem.dataset.index);

                    // Remove the dragged item from its old position
                    const [draggedItemData] = ticketTypes.splice(draggedIndex, 1);

                    // Insert the dragged item at its new position
                    ticketTypes.splice(targetIndex, 0, draggedItemData);
                    saveTicketTypes();
                    renderTicketTypes();  //Re-render the list.
                    draggedItem = null;
                }
            });

            ticketList.addEventListener('dragend', (event)=>{
                event.preventDefault();
                draggedItem = null;
                // event.target.classList.remove('dragging');
            })
        }
    </script>
</body>
</html>
